\ProvidesPackage{cqupt_style}


% ==========================================
% 1. 基础宏包加载 (Core Dependencies)
% ==========================================
\RequirePackage{etoolbox}
\RequirePackage{tikz}
\RequirePackage{listings}
\RequirePackage{graphicx}
% \RequirePackage{geometry}
\RequirePackage{amsfonts, amsmath, bm, oldgerm, lmodern}  % about math
% \RequirePackage{verbatim}
\RequirePackage{animate}
% \RequirePackage{xcolor}
\RequirePackage{ifplatform}


% ==========================================
% 2. 选项定义与语言环境 (Options & Localization)
% ==========================================
\newcommand{\tocStr}{Table of Contents}
\newcommand{\qaStr}{\textsl{Thank you for listening!}}

\newif\ifcollegebeamer@zh

% English option
\DeclareOption{en}{
    \renewcommand{\tocStr}{Table of Contents}
    \renewcommand{\qaStr}{\textsl{Thank you for listening!}}
}

% English option
\DeclareOption{zh}{
    \collegebeamer@zhtrue
    \AtEndOfPackage{
        \RequirePackage{ifxetex}
        \RequirePackage{xeCJK}

        % --- 手动中文日期格式化 ---
        \renewcommand{\today}{\the\year 年 \the\month 月 \the\day 日}
    
        % 操作系统字体适配
        \ifwindows
            \typeout{Detected: Windows}
            \setCJKmainfont{SimSun}
            \setCJKsansfont{Noto Sans CJK SC}
            \setCJKmonofont{NSimSun}
        \fi
        \ifmacosx
            \typeout{Detected: macOS}
            \setCJKmainfont{Songti SC}
            \setCJKsansfont{PingFang SC}
            \setCJKmonofont{Menlo}
        \fi
        \iflinux
            \typeout{Detected: Linux (including Overleaf!)}
            \setCJKmainfont{Noto Serif CJK SC}
            \setCJKsansfont{Noto Sans CJK SC}
            \setCJKmonofont{Noto Sans Mono CJK SC}
        \fi

        \renewcommand{\tocStr}{目录}
        \renewcommand{\qaStr}{\textbf{请各位老师批评指正}}

        % 安全检查
        \ifxetex\else
            \PackageError{cqupt_style}{请使用 XeLaTeX 编译！}{}
        \fi
    }
}

\ProcessOptions\relax


% ==========================================
% 3. 颜色、资源与字体基础 (Styling Base)
% ==========================================

% 颜色定义
\definecolor{cqupt_green}{HTML}{00784B}
\definecolor{cqupt_yellow}{HTML}{FFE57A}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codegreen}{RGB}{101,218,120}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{darkgreen}{RGB}{93,158,82}
\definecolor{darkyellow}{RGB}{245,194,105}
\definecolor{blackcolour}{rgb}{0.95,0.95,0.92}
\definecolor{airforceblue}{rgb}{0.36, 0.54, 0.66}
\definecolor{morelightgray}{rgb}{0.9, 0.9, 0.9}

\colorlet{maincolor}{cqupt_green}  % 统一主色

% 路径设置
\newcommand{\logoPath}{assets/imgs/logo.png}  % path to the logo image with transparent
\newcommand{\backgroundPath}{assets/imgs/background.png}  % path to the background image

% 页面比例与基本字体
\geometry{paperwidth=16cm,paperheight=9cm}  % force 16:9 aspect ratio
\usefonttheme{serif}  % basic font 

% 动态标题字体设置
\AtEndOfPackage{
    \ifcollegebeamer@zh
        \setbeamerfont{title}{series=\bfseries, size=\Large}
    \else
        \setbeamerfont{title}{series=\scshape, size=\Large}
    \fi
}


% ==========================================
% 4. Beamer 元素风格 (UI Components)
% ==========================================

% 导航与颜色
\setbeamertemplate{navigation symbols}{}
\setbeamercolor{title}{fg=maincolor}
\setbeamercolor{alerted text}{fg=maincolor}
\setbeamercolor{author}{fg=black}
\setbeamercolor{date}{fg=black}

% 标题与副标题字体
\setbeamerfont{subtitle}{series=\mdseries, size=\normalsize}
\setbeamerfont{author}{size=\normalsize}
\setbeamerfont{date}{size=\normalsize}
\setbeamerfont{frametitle}{series=\bfseries}
\setbeamerfont{framesubtitle}{series=\mdseries}
\setbeamerfont{footline}{size=\tiny}

% Block 样式
\setbeamertemplate{blocks}[rounded]
\setbeamerfont{block title}{series=\centering, size=\small}
\setbeamerfont{block body}{size=\scriptsize}
\setbeamercolor{block title}{fg=airforceblue, bg=morelightgray}
\setbeamercolor{block body}{fg=darkgray, bg=morelightgray}

% 列表项符号 (Items)
\setbeamertemplate{itemize item}{\textbullet}
\setbeamertemplate{itemize subitem}{\textemdash}
\setbeamertemplate{itemize subsubitem}{\ensuremath{\circ}}

% 目录设置 (TOC)
\setbeamertemplate{section in toc}{$\blacktriangleright$~\inserttocsection}  % section name format
\setbeamertemplate{subsection in toc}{}  % don't present subsection

% 代码块设置 (Listings)
\lstdefinestyle{codestyle}{
    % color and font highlighting
    commentstyle=\color{airforceblue},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\scriptsize,
    % automated typesetting
    breaklines=true,
    breakatwhitespace=true,
    keepspaces=false,
    tabsize=4,
    % line numbers and spacing
    numbers=left,
    numbersep=5pt,
    xleftmargin=10pt,
    xrightmargin=10pt,
    % auxiliary symbol display
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    captionpos=b,
}
\lstset{style=codestyle}


% ==========================================
% 5. 布局逻辑 (Structure Logic)
% ==========================================

% 页眉 Logo 设置
\pgfdeclareimage[width=0.06\paperwidth]{logo}{\logoPath}
\newcommand{\@makelogo}{logo}

\setbeamertemplate{headline}{
    \vspace{3mm}
    \begin{beamercolorbox}[wd=\paperwidth, right, rightskip=0.03\paperwidth]{headline}
        \pgfuseimage{\@makelogo}
    \end{beamercolorbox}
}

% 动态主题配色切换逻辑
\newcommand{\themecolor}[1]{
    \renewcommand{\@makelogo}{logo}
    \ifstrequal{#1}{white}{
        \setbeamercolor{normal text}{fg=darkgray, bg=white}
        \setbeamercolor{structure}{fg=maincolor}
    }{
        \setbeamercolor{normal text}{fg=white, bg=maincolor}
        \setbeamercolor{structure}{fg=white}
    }
}
\themecolor{white}  % 初始默认

% 页脚 (Footline) 设置
\newcommand{\topic}[1]{\def\inserttopic{#1}}
\topic{}

\setbeamercolor{foot_author}{fg=white, bg=cqupt_green}
\setbeamercolor{foot_topic}{fg=black, bg=cqupt_yellow}
\setbeamercolor{foot_date}{fg=black, bg=gray!20}
\setbeamercolor{foot_num}{fg=cqupt_green, bg=white}

\setbeamertemplate{footline}{
    \leavevmode
    \hbox{%
        % 左：作者信息
        \begin{beamercolorbox}[wd=.3\paperwidth, ht=2.5ex, dp=1.0ex, center]{foot_author}
            \insertshortauthor-\insertsid
        \end{beamercolorbox}%
        % 中左：自定义主题
        \begin{beamercolorbox}[wd=.4\paperwidth, ht=2.5ex, dp=1.0ex, center]{foot_topic}
            \inserttopic
        \end{beamercolorbox}%
        % 中右：日期
        \begin{beamercolorbox}[wd=.2\paperwidth, ht=2.5ex, dp=1.0ex, center]{foot_date}
            \insertshortdate{}
        \end{beamercolorbox}
        % 右：页码
        \begin{beamercolorbox}[wd=.1\paperwidth, ht=2.5ex, dp=1.0ex, center]{foot_num}
            \insertframenumber{}/\inserttotalframenumber
        \end{beamercolorbox}
    }
    \vskip0pt
}

% 帧标题设置 (Frametitle)
\setbeamertemplate{frametitle}{
    \vspace*{-3.5ex}
    \begin{beamercolorbox}[leftskip=0cm, wd=\textwidth]{frametitle}
        \usebeamerfont{frametitle}\insertframetitle\\
        \usebeamerfont{framesubtitle}\insertframesubtitle
    \end{beamercolorbox}
    \vspace{-1ex}\rule{0.7\textwidth}{1.0pt}
}

\makeatletter
    \newcommand{\@autoSubTitle}{\thesection \, \secname}

    \pretocmd\beamer@checkframetitle{
        \ifx\insertframesubtitle\@empty
            \framesubtitle{\@autoSubTitle}
        \fi
    }{}{}
\makeatother

\setbeamertemplate{frametitle continuation}{}

% ==========================================
% 6. 自动化页面生成 (Automatic Pages)
% ==========================================

% 章节首页
\AtBeginSection[]{
    \begingroup
        \renewcommand{\framesubtitle}[1]{}
        \themecolor{colored}
        \setbeamertemplate{footline}{}    
        \begin{frame}{\tocStr}
            \tableofcontents[currentsection]
        \end{frame}
    \endgroup
}

% 子章节首页
\AtBeginSubsection[]{
    \begin{frame}{\,}{\thesection \, \secname}
        \fontfamily{ptm}\selectfont
        \centering\textsl{\textbf{\textcolor{maincolor}{
            \large Section \thesection.\thesubsection
            \vskip15pt
            \LARGE \subsecname
        }}}
    \end{frame}
}

% 标题页 (Title Page)
\newcommand{\sid}[1]{\def\insertsid{#1}}
\newcommand{\advisor}[1]{\def\insertadvisor{#1}}
\setbeamertemplate{title page}{
    \vfill
    \begin{beamercolorbox}[wd=0.9\paperwidth, sep=10pt]{title}
        {\usebeamerfont{title}\inserttitle}\\[5pt]
        {\usebeamerfont{subtitle}\insertsubtitle}\\[15pt]
        \begin{minipage}{0.6\textwidth}
            \setbeamerfont{author}{size=\small}
            \usebeamerfont{author}\usebeamercolor[fg]{author}
            \makebox[5em][s]{汇报人}：\insertauthor \\[5pt]
            \makebox[5em][s]{指导老师}：\insertadvisor \\[5pt]
            \makebox[5em][s]{汇报时间}：\insertdate
        \end{minipage}
    \end{beamercolorbox}
    \vfill
}

\renewcommand{\maketitle}{
    \begingroup
        \setbeamertemplate{footline}{}
        \setbeamertemplate{background}{
            \includegraphics[height=\paperheight]{\backgroundPath}
        }
        \begin{frame}
            \titlepage
        \end{frame}
    \endgroup
}

% 结尾页与参考文献
\newcommand{\QApage}{
    \begingroup
        \setbeamertemplate{footline}{}
        \themecolor{colored}
        \begin{frame}{}
            \centering
            \begin{minipage}{\textwidth}
                \usebeamercolor[fg]{normal text}
                \centering
                \Large \qaStr
            \end{minipage}
        \end{frame}
    \endgroup
}

\newcommand{\bibliographpage}{
    \section{References}
    \begingroup
        \themecolor{colored}
        \begin{frame}[allowframebreaks]{References}{\,}
            \tiny
            \printbibliography[heading=none]
        \end{frame}
    \endgroup
}


% ==========================================
% 7. 自定义辅助命令 (Helper Commands)
% ==========================================

% set colored hyperlinks command
\newcommand{\bhref}[2]{\textcolor{airforceblue}{\href{#1}{#2}}}

% centering paragraph statement
\newcommand{\centerstate}[1]{
    \centering
    \begin{columns}
        \begin{column}{0.8\textwidth}
            #1
        \end{column}
    \end{columns}
}

\newcommand{\tbf}[1]{\texttt{\textcolor{airforceblue}{[#1]}}}

% coloured textbf
\newcommand{\ctextbf}[1]{\textbf{\textcolor{maincolor}{#1}}}
\newcommand{\btextbf}[1]{\textbf{\textcolor{airforceblue}{#1}}}

% coloured textsl
\newcommand{\ctextsl}[1]{\textsl{\textcolor{maincolor}{#1}}}
\newcommand{\btextsl}[1]{\textsl{\textcolor{airforceblue}{#1}}}

% coloured emph
\newcommand{\cemph}[1]{\emph{\textcolor{maincolor}{#1}}}
\newcommand{\bemph}[1]{\emph{\textcolor{airforceblue}{#1}}}

% coloured texttt
\newcommand{\ctexttt}[1]{\texttt{\textcolor{maincolor}{#1}}}
\newcommand{\btexttt}[1]{\texttt{\textcolor{airforceblue}{#1}}}

\endinput